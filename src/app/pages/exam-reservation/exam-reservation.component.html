<div class="exam-reservation-container" *ngIf="!loading; else loadingTpl">
  
  <!-- Ù‡Ø¯Ø± ØµÙØ­Ù‡ -->
  <div class="reservation-header-section">
    <div class="header-content">
      <button class="back-btn" (click)="goBack()">â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø±Ø³</button>
      <div class="page-title">
        <h1>Ø±Ø²Ø±Ùˆ Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÛŒØ¯</h1>
        <p>Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ØŒ Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ø±Ø²Ø±Ùˆ Ú©Ù†ÛŒØ¯</p>
      </div>
      
      <!-- Ø¯Ú©Ù…Ù‡ Ø±ÙØ±Ø´ -->
      <button class="refresh-btn" (click)="forceRefresh()" [disabled]="loading">
        ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
      </button>
    </div>
  </div>

  <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚ÛŒØª Ùˆ Ø®Ø·Ø§ -->
  <div *ngIf="successMessage" class="success-message">
    âœ… {{ successMessage }}
  </div>
  
  <div *ngIf="errorMessage" class="error-message">
    âŒ {{ errorMessage }}
  </div>

  <!-- Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„: ØªÙ‚ÙˆÛŒÙ… + ÙØ±Ù… -->
  <div class="row-1">
    <!-- ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ -->
    <div class="calendar-card">
      <div class="calendar-header">
        <div class="calendar-nav">
          <!-- <button class="cal-nav-btn" (click)="prevYear()">Â« Ø³Ø§Ù„ Ù‚Ø¨Ù„</button> -->
          <button class="cal-nav-btn" (click)="prevMonth()">â€¹ Ù…Ø§Ù‡ Ù‚Ø¨Ù„</button>
        </div>
        
        <div class="calendar-title">
          <h3 class="month-name">{{ monthName }}</h3>
          <div class="year-text">{{ currentYear }}</div>
        </div>
        
        <div class="calendar-nav">
          <button class="cal-nav-btn" (click)="nextMonth()">Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ â€º</button>
          <!-- <button class="cal-nav-btn" (click)="nextYear()">Ø³Ø§Ù„ Ø¨Ø¹Ø¯ Â»</button> -->
        </div>
      </div>

      <div class="week-days">
        <div *ngFor="let day of daysOfWeek">{{ day }}</div>
      </div>

      <div class="calendar-grid">
        <div
          *ngFor="let day of calendarGrid"
          class="cal-day"
          [ngClass]="{
            'cal-today': day.isToday,
            'cal-selected': day.isSelected,
            'cal-empty': day.day === null,
            'cal-excellent': day.dateAnalysis?.recommendationGroup === 'EXCELLENT',
            'cal-good': day.dateAnalysis?.recommendationGroup === 'GOOD',
            'cal-fair': day.dateAnalysis?.recommendationGroup === 'FAIR',
            'cal-poor': day.dateAnalysis?.recommendationGroup === 'POOR'
          }"
          (click)="day.gregorianDate && onDateSelect(day.gregorianDate)"
          [title]="getRecommendationTooltip(day.dateAnalysis)"
        >
          {{ day.day ?? '' }}
          
          <!-- Ù†Ø´Ø§Ù†Ú¯Ø± ØªØ­Ù„ÛŒÙ„ -->
          <div *ngIf="day.dateAnalysis" class="cal-recommendation-text">
            {{ 
              day.dateAnalysis.recommendationGroup === 'EXCELLENT' ? 'Ø¹Ø§Ù„ÛŒ' :
              day.dateAnalysis.recommendationGroup === 'GOOD' ? 'Ø®ÙˆØ¨' :
              day.dateAnalysis.recommendationGroup === 'FAIR' ? 'Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„' :
              day.dateAnalysis.recommendationGroup === 'POOR' ? 'Ù†Ø§ Ù…Ù†Ø§Ø³Ø¨' : ''
            }}
          </div>
        </div>
      </div>
      
      <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ -->
      <div class="analysis-legend">
        <div class="analysis-legend-item">
          <div class="analysis-legend-color legend-excellent"></div>
          <span>Ø¹Ø§Ù„ÛŒ (EXCELLENT)</span>
        </div>
        <div class="analysis-legend-item">
          <div class="analysis-legend-color legend-good"></div>
          <span>Ø®ÙˆØ¨ (GOOD)</span>
        </div>
        <div class="analysis-legend-item">
          <div class="analysis-legend-color legend-fair"></div>
          <span>Ù…ØªÙˆØ³Ø· (FAIR)</span>
        </div>
        <div class="analysis-legend-item">
          <div class="analysis-legend-color legend-poor"></div>
          <span>Ø¶Ø¹ÛŒÙ (POOR)</span>
        </div>
      </div>
      
      <div *ngIf="selectedDate" class="selected-date-info">
        <div class="selected-date-label">ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</div>
        <div class="selected-date-value">
          {{ getPersianDay(selectedDate) }}ØŒ {{ selectedJalaaliDate }}
        </div>
        <!-- Ù†Ù…Ø§ÛŒØ´ ØªØ­Ù„ÛŒÙ„ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ -->
        <div *ngIf="getRecommendationForDate(selectedDate)" class="selected-date-analysis">
          <div [ngClass]="'analysis-status ' + getRecommendationClass(getRecommendationForDate(selectedDate)?.recommendationGroup || '')">
            ÙˆØ¶Ø¹ÛŒØª: 
            {{
              getRecommendationForDate(selectedDate)?.recommendationGroup === 'EXCELLENT' ? 'Ø¹Ø§Ù„ÛŒ' :
              getRecommendationForDate(selectedDate)?.recommendationGroup === 'GOOD' ? 'Ø®ÙˆØ¨' :
              getRecommendationForDate(selectedDate)?.recommendationGroup === 'FAIR' ? 'Ù…ØªÙˆØ³Ø·' :
              getRecommendationForDate(selectedDate)?.recommendationGroup === 'POOR' ? 'Ø¶Ø¹ÛŒÙ' : 'Ø¨Ø¯ÙˆÙ† ØªØ­Ù„ÛŒÙ„'
            }}
            ({{ getRecommendationForDate(selectedDate)?.studentsOnDayPercent | number:'1.0-0' }}Ùª Ø§Ù…ØªØ­Ø§Ù† Ø¯Ø§Ø±Ù†Ø¯)
          </div>
        </div>
      </div>
    </div>

    <!-- ÙØ±Ù… Ø±Ø²Ø±Ùˆ -->
    <div class="reservation-form-card">
      <div class="form-header">
        <div class="icon-bar"></div>
        <h2>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø²Ø±Ùˆ</h2>
      </div>
      
      <div class="form-body">
        <!-- Ù†Ø§Ù… Ø§Ù…ØªØ­Ø§Ù† -->
        <div class="form-group">
          <label for="examName">Ù†Ø§Ù… Ø§Ù…ØªØ­Ø§Ù† *</label>
          <input
            type="text"
            id="examName"
            [(ngModel)]="examName"
            placeholder="Ù…Ø«Ø§Ù„: Ø¢Ø²Ù…ÙˆÙ† Ù…ÛŒØ§Ù†â€ŒØªØ±Ù… Ø±ÛŒØ§Ø¶ÛŒ"
            [ngClass]="{ 'input-error': examNameError }"
          />
          <div *ngIf="examNameError" class="error-text">{{ examNameError }}</div>
        </div>
        
        <!-- Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ -->
        <div class="form-group">
          <label>Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ *</label>
          <div class="time-selector">
            <select [(ngModel)]="selectedStartTime" (change)="onStartTimeChange(selectedStartTime)">
              <option *ngFor="let slot of timeSlots" [value]="slot.display" [disabled]="slot.disabled">
                {{ slot.display }}
              </option>
            </select>
            <span class="time-icon">â°</span>
          </div>
        </div>
        
        <!-- Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† -->
        <div class="form-group">
          <label>Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† *</label>
          <div class="time-selector">
            <select [(ngModel)]="selectedEndTime" (change)="onEndTimeChange(selectedEndTime)">
              <option *ngFor="let slot of timeSlots" [value]="slot.display">
                {{ slot.display }}
              </option>
            </select>
            <span class="time-icon">â°</span>
          </div>
        </div>
        <!-- Ù…Ø¯Øª Ø²Ù…Ø§Ù† -->
        <div class="form-group">
            <label>Ù…Ø¯Øª Ø²Ù…Ø§Ù†</label>
            <div class="duration-display">
                <span class="duration-value">{{ calculateDuration() }}</span>
                <span class="duration-unit">Ø¯Ù‚ÛŒÙ‚Ù‡</span>
            </div>
        </div>
        
        <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§Ù„Ù† -->
        <div class="form-group">
          <label>Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§Ù„Ù† *</label>
          <div class="room-grid">
            <div
              *ngFor="let room of allRooms"
              class="room-card"
              [ngClass]="{ 'room-selected': selectedRoomId === room.id.toString() }"
              (click)="onRoomSelect(room.id.toString())"
            >
              <div class="room-icon">ğŸ«</div>
              <div class="room-info">
                <div class="room-name">{{ room.name }}</div>
                <div class="room-capacity">Ø¸Ø±ÙÛŒØª: {{ room.capacity }} Ù†ÙØ±</div>
              </div>
              <div *ngIf="selectedRoomId === room.id.toString()" class="room-check">âœ“</div>
            </div>
          </div>
        </div>
        
        <!-- ÙˆØ¶Ø¹ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø§Ù„Ù† -->
        <div *ngIf="selectedRoomId && selectedDate" class="room-availability-status">
          <div *ngIf="isRoomAvailableForSelectedTime()" class="availability-available">
            âœ… Ø³Ø§Ù„Ù† Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª
          </div>
          <div *ngIf="!isRoomAvailableForSelectedTime()" class="availability-busy">
            âŒ Ø³Ø§Ù„Ù† Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø§Ø´ØºØ§Ù„ Ø§Ø³Øª
          </div>
        </div>
        
        <!-- Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª -->
        <div class="form-actions">
          <button
            class="submit-btn"
            (click)="submitReservation()"
            [disabled]="submitting || !isRoomAvailableForSelectedTime()"
          >
            <span *ngIf="submitting" class="spinner-small"></span>
            {{ submitting ? 'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...' : 'Ø«Ø¨Øª Ø±Ø²Ø±Ùˆ' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ ÙˆØ¶Ø¹ÛŒØª Ø³Ø§Ù„Ù†â€ŒÙ‡Ø§ -->
  <div class="availability-table-card">
    <div class="table-header">
      <div class="icon-bar"></div>
      <h2>ÙˆØ¶Ø¹ÛŒØª Ø³Ø§Ù„Ù†â€ŒÙ‡Ø§ Ø¯Ø± ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡</h2>
      <div *ngIf="selectedDate" class="table-date">
        {{ selectedJalaaliDate }}
        <span *ngIf="getRecommendationForDate(selectedDate)" class="table-date-analysis">
          - 
          <span [ngClass]="'analysis-badge ' + getRecommendationClass(getRecommendationForDate(selectedDate)?.recommendationGroup || '')">
            {{
              getRecommendationForDate(selectedDate)?.recommendationGroup === 'EXCELLENT' ? 'Ø¹Ø§Ù„ÛŒ' :
              getRecommendationForDate(selectedDate)?.recommendationGroup === 'GOOD' ? 'Ø®ÙˆØ¨' :
              getRecommendationForDate(selectedDate)?.recommendationGroup === 'FAIR' ? 'Ù…ØªÙˆØ³Ø·' :
              getRecommendationForDate(selectedDate)?.recommendationGroup === 'POOR' ? 'Ø¶Ø¹ÛŒÙ' : ''
            }}
          </span>
        </span>
      </div>
    </div>
    
    <div *ngIf="!selectedDate" class="no-date-selected">
      <div class="no-date-icon">ğŸ“…</div>
      <p>Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ø² ØªÙ‚ÙˆÛŒÙ… Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
    </div>
    
    <div *ngIf="selectedDate" class="availability-table-container">
      <div class="time-header">
        <div class="room-header-cell">Ø³Ø§Ù„Ù† / Ø²Ù…Ø§Ù†</div>
        <div *ngFor="let slot of roomAvailabilities[0]?.availability || []" class="time-cell">
          {{ slot.startTime }}
        </div>
      </div>
      
      <div class="table-body">
        <div *ngFor="let roomAvailability of roomAvailabilities" class="room-row">
          <div class="room-cell">
            <div class="room-cell-name">{{ roomAvailability.room.name }}</div>
            <div class="room-cell-capacity">{{ roomAvailability.room.capacity }} Ù†ÙØ±</div>
          </div>
          
          <div
  *ngFor="let slot of roomAvailability.availability"
  class="slot-cell"
  [ngClass]="{
    'slot-available': slot.isAvailable,
    'slot-busy': !slot.isAvailable
  }"
  [title]="getSlotTitle(slot)"
>
  {{ slot.isAvailable ? 'âœ“' : 'âœ—' }}
</div>
        </div>
      </div>
      
      <div class="table-legend">
        <div class="legend-item">
          <div class="legend-color legend-available"></div>
          <span>Ø®Ø§Ù„ÛŒ</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-busy"></div>
          <span>Ø§Ø´ØºØ§Ù„</span>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
<ng-template #loadingTpl>
  <div class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p class="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</p>
      <p *ngIf="loadingAnalysis" style="margin-top: 10px; font-size: 14px; opacity: 0.8;">
        Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ØªØ­Ù„ÛŒÙ„ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§...
      </p>
    </div>
  </div>
</ng-template>
