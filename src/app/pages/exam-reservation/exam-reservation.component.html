<div class="exam-reservation-container" *ngIf="!loading; else loadingTpl">
  
  <!-- ูุฏุฑ ุตูุญู -->
  <!-- ุฏุฑ ุจุฎุด ูุฏุฑ ุตูุญู -->
<div class="reservation-header-section">
  <div class="header-content">
    <button class="back-btn" (click)="goBack()">โ ุจุงุฒฺฏุดุช ุจู ุฏุฑุณ</button>
    <div class="page-title">
      <h1>ุฑุฒุฑู ุงูุชุญุงู ุฌุฏุฏ</h1>
      <p>ุจุฑุง ุฏุฑุณ ุงูุชุฎุงุจ ุดุฏูุ ุงูุชุญุงู ุฌุฏุฏ ุฑุฒุฑู ฺฉูุฏ</p>
    </div>
    
    <!-- ุฏฺฉูู ุฑูุฑุด -->
    <button class="refresh-btn" (click)="forceRefresh()" [disabled]="loading">
      ๐ ุจุฑูุฒุฑุณุงู
    </button>
  </div>
</div>

  <!-- ูพุงูโูุง ููููุช ู ุฎุทุง -->
  <div *ngIf="successMessage" class="success-message">
    โ {{ successMessage }}
  </div>
  
  <div *ngIf="errorMessage" class="error-message">
    โ {{ errorMessage }}
  </div>

  <!-- ุฑุฏู ุงูู: ุชููู + ูุฑู -->
  <div class="row-1">
    <!-- ุชููู ุดูุณ -->
    <div class="calendar-card">
      <div class="calendar-header">
        <div class="calendar-nav">
          <button class="cal-nav-btn" (click)="prevYear()">ยซ ุณุงู ูุจู</button>
          <button class="cal-nav-btn" (click)="prevMonth()">โน ูุงู ูุจู</button>
        </div>
        
        <div class="calendar-title">
          <h3 class="month-name">{{ monthName }}</h3>
          <div class="year-text">{{ currentYear }}</div>
        </div>
        
        <div class="calendar-nav">
          <button class="cal-nav-btn" (click)="nextMonth()">ูุงู ุจุนุฏ โบ</button>
          <button class="cal-nav-btn" (click)="nextYear()">ุณุงู ุจุนุฏ ยป</button>
        </div>
      </div>

      <div class="week-days">
        <div *ngFor="let day of daysOfWeek">{{ day }}</div>
      </div>

      <div class="calendar-grid">
        <div
          *ngFor="let day of calendarGrid"
          class="cal-day"
          [ngClass]="{
            'cal-today': day.isToday,
            'cal-selected': day.isSelected,
            'cal-empty': day.day === null
          }"
          (click)="day.gregorianDate && onDateSelect(day.gregorianDate)"
        >
          {{ day.day ?? '' }}
        </div>
      </div>
      
      <div *ngIf="selectedDate" class="selected-date-info">
        <div class="selected-date-label">ุชุงุฑุฎ ุงูุชุฎุงุจ ุดุฏู:</div>
        <div class="selected-date-value">
          {{ getPersianDay(selectedDate) }}ุ {{ selectedJalaaliDate }}
        </div>
      </div>
    </div>

    <!-- ูุฑู ุฑุฒุฑู -->
    <div class="reservation-form-card">
      <div class="form-header">
        <div class="icon-bar"></div>
        <h2>ุงุทูุงุนุงุช ุฑุฒุฑู</h2>
      </div>
      
      <div class="form-body">
        <!-- ูุงู ุงูุชุญุงู -->
        <div class="form-group">
          <label for="examName">ูุงู ุงูุชุญุงู *</label>
          <input
            type="text"
            id="examName"
            [(ngModel)]="examName"
            placeholder="ูุซุงู: ุขุฒููู ูุงูโุชุฑู ุฑุงุถ"
            [ngClass]="{ 'input-error': examNameError }"
          />
          <div *ngIf="examNameError" class="error-text">{{ examNameError }}</div>
        </div>
        
        <!-- ุฒูุงู ุดุฑูุน -->
        <div class="form-group">
          <label>ุฒูุงู ุดุฑูุน *</label>
          <div class="time-selector">
            <select [(ngModel)]="selectedStartTime" (change)="onStartTimeChange(selectedStartTime)">
              <option *ngFor="let slot of timeSlots" [value]="slot.display" [disabled]="slot.disabled">
                {{ slot.display }}
              </option>
            </select>
            <span class="time-icon">โฐ</span>
          </div>
        </div>
        
        <!-- ุฒูุงู ูพุงุงู -->
        <div class="form-group">
          <label>ุฒูุงู ูพุงุงู *</label>
          <div class="time-selector">
            <select [(ngModel)]="selectedEndTime" (change)="onEndTimeChange(selectedEndTime)">
              <option *ngFor="let slot of timeSlots" [value]="slot.display">
                {{ slot.display }}
              </option>
            </select>
            <span class="time-icon">โฐ</span>
          </div>
        </div>
        <!-- ูุฏุช ุฒูุงู -->
        <div class="form-group">
            <label>ูุฏุช ุฒูุงู</label>
            <div class="duration-display">
                <span class="duration-value">{{ calculateDuration() }}</span>
                <span class="duration-unit">ุฏููู</span>
            </div>
        </div>
        
        <!-- ุงูุชุฎุงุจ ุณุงูู -->
        <div class="form-group">
          <label>ุงูุชุฎุงุจ ุณุงูู *</label>
          <div class="room-grid">
            <div
              *ngFor="let room of allRooms"
              class="room-card"
              [ngClass]="{ 'room-selected': selectedRoomId === room.id.toString() }"
              (click)="onRoomSelect(room.id.toString())"
            >
              <div class="room-icon">๐ซ</div>
              <div class="room-info">
                <div class="room-name">{{ room.name }}</div>
                <div class="room-capacity">ุธุฑูุช: {{ room.capacity }} ููุฑ</div>
              </div>
              <div *ngIf="selectedRoomId === room.id.toString()" class="room-check">โ</div>
            </div>
          </div>
        </div>
        
        <!-- ูุถุนุช ุฏุณุชุฑุณ ุณุงูู -->
        <div *ngIf="selectedRoomId && selectedDate" class="room-availability-status">
          <div *ngIf="isRoomAvailableForSelectedTime()" class="availability-available">
            โ ุณุงูู ุฏุฑ ุงู ุจุงุฒู ุฒูุงู ุฏุฑ ุฏุณุชุฑุณ ุงุณุช
          </div>
          <div *ngIf="!isRoomAvailableForSelectedTime()" class="availability-busy">
            โ ุณุงูู ุฏุฑ ุงู ุจุงุฒู ุฒูุงู ุงุดุบุงู ุงุณุช
          </div>
        </div>
        
        <!-- ุฏฺฉูู ุซุจุช -->
        <div class="form-actions">
          <button
            class="submit-btn"
            (click)="submitReservation()"
            [disabled]="submitting || !isRoomAvailableForSelectedTime()"
          >
            <span *ngIf="submitting" class="spinner-small"></span>
            {{ submitting ? 'ุฏุฑ ุญุงู ุซุจุช...' : 'ุซุจุช ุฑุฒุฑู' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ุฌุฏูู ูุถุนุช ุณุงููโูุง -->
  <div class="availability-table-card">
    <div class="table-header">
      <div class="icon-bar"></div>
      <h2>ูุถุนุช ุณุงููโูุง ุฏุฑ ุชุงุฑุฎ ุงูุชุฎุงุจ ุดุฏู</h2>
      <div *ngIf="selectedDate" class="table-date">
        {{ selectedJalaaliDate }}
      </div>
    </div>
    
    <div *ngIf="!selectedDate" class="no-date-selected">
      <div class="no-date-icon">๐</div>
      <p>ูุทูุงู ุงุจุชุฏุง ุชุงุฑุฎ ุฑุง ุงุฒ ุชููู ุงูุชุฎุงุจ ฺฉูุฏ</p>
    </div>
    
    <div *ngIf="selectedDate" class="availability-table-container">
      <div class="time-header">
        <div class="room-header-cell">ุณุงูู / ุฒูุงู</div>
        <div *ngFor="let slot of roomAvailabilities[0]?.availability || []" class="time-cell">
          {{ slot.startTime }}
        </div>
      </div>
      
      <div class="table-body">
        <div *ngFor="let roomAvailability of roomAvailabilities" class="room-row">
          <div class="room-cell">
            <div class="room-cell-name">{{ roomAvailability.room.name }}</div>
            <div class="room-cell-capacity">{{ roomAvailability.room.capacity }} ููุฑ</div>
          </div>
          
          <div
  *ngFor="let slot of roomAvailability.availability"
  class="slot-cell"
  [ngClass]="{
    'slot-available': slot.isAvailable,
    'slot-busy': !slot.isAvailable
  }"
  [title]="getSlotTitle(slot)"
>
  {{ slot.isAvailable ? 'โ' : 'โ' }}
</div>
        </div>
      </div>
      
      <div class="table-legend">
        <div class="legend-item">
          <div class="legend-color legend-available"></div>
          <span>ุฎุงู</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-busy"></div>
          <span>ุงุดุบุงู</span>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ููุฏูฺฏ -->
<ng-template #loadingTpl>
  <div class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p class="loading-text">ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ุงุทูุงุนุงุช...</p>
    </div>
  </div>
</ng-template>